name: Command Executor

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      command:
        description: 'Command to execute'
        required: true
        type: string

jobs:
  execute-command:
    # Only run if issue has 'command' label or workflow_dispatch
    if: contains(github.event.issue.labels.*.name, 'command') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .claude/automation
          npm install

      - name: Parse command
        id: parse
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            COMMAND="${{ github.event.inputs.command }}"
          else
            # Extract command from issue body
            COMMAND=$(echo "${{ github.event.issue.body }}" | head -1)
          fi
          echo "command=$COMMAND" >> $GITHUB_OUTPUT

      - name: Execute automation command
        id: execute
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_ROADMAP_DB_ID: ${{ secrets.NOTION_ROADMAP_DB_ID }}
        run: |
          cd .claude/automation
          COMMAND="${{ steps.parse.outputs.command }}"

          # Remove any leading slash or whitespace
          COMMAND=$(echo "$COMMAND" | sed 's/^[\/[:space:]]*//')

          case "$COMMAND" in
            sync|"roadmap sync")
              npm run sync 2>&1 | tee output.txt
              ;;
            wip|"wip sync"|"wip:sync")
              npm run wip:sync 2>&1 | tee output.txt
              ;;
            deadline|"deadline alerts"|"alerts:deadline")
              npm run alerts:deadline 2>&1 | tee output.txt
              ;;
            blocked|"blocked alerts"|"alerts:blocked")
              npm run alerts:blocked 2>&1 | tee output.txt
              ;;
            summary|"weekly summary"|"summary:weekly")
              npm run summary:weekly 2>&1 | tee output.txt
              ;;
            all|"run all"|"test:all")
              npm run test:all 2>&1 | tee output.txt
              ;;
            *)
              echo "Unknown command: $COMMAND" > output.txt
              echo "" >> output.txt
              echo "Available commands:" >> output.txt
              echo "- sync: Sync roadmap to Notion" >> output.txt
              echo "- wip: Run daily WIP sync" >> output.txt
              echo "- deadline: Check deadline alerts" >> output.txt
              echo "- blocked: Check blocked tasks" >> output.txt
              echo "- summary: Generate weekly summary" >> output.txt
              echo "- all: Run all automations" >> output.txt
              ;;
          esac

          # Read output for comment
          OUTPUT=$(cat output.txt)
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment result on issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.execute.outputs.output }}`;
            const comment = `## âœ… Command Executed\n\n\`\`\`\n${output}\n\`\`\`\n\n*Executed by GitHub Actions at ${new Date().toISOString()}*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Close issue after execution
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: ['command', 'executed']
            });

      - name: Create summary
        if: always()
        run: |
          echo "### Command Execution Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Command:** ${{ steps.parse.outputs.command }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Output:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat .claude/automation/output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
