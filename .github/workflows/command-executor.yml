name: Command Executor

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      command:
        description: 'Command to execute'
        required: true
        type: string

jobs:
  execute-command:
    # Only run if issue has 'command' label or workflow_dispatch
    if: contains(github.event.issue.labels.*.name, 'command') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .claude/automation
          npm install

      - name: Parse command
        id: parse
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            COMMAND="${{ github.event.inputs.command }}"
          else
            # Extract command from issue body
            COMMAND=$(echo "${{ github.event.issue.body }}" | head -1)
          fi
          echo "command=$COMMAND" >> $GITHUB_OUTPUT

      - name: Execute automation command
        id: execute
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_ROADMAP_DB_ID: ${{ secrets.NOTION_ROADMAP_DB_ID }}
        run: |
          cd .claude/automation
          COMMAND="${{ steps.parse.outputs.command }}"

          # Remove any leading slash or whitespace
          COMMAND=$(echo "$COMMAND" | sed 's/^[\/[:space:]]*//')

          case "$COMMAND" in
            sync|"roadmap sync")
              npm run sync 2>&1 | tee output.txt
              ;;
            wip|"wip sync"|"wip:sync")
              npm run wip:sync 2>&1 | tee output.txt
              ;;
            deadline|"deadline alerts"|"alerts:deadline")
              npm run alerts:deadline 2>&1 | tee output.txt
              ;;
            blocked|"blocked alerts"|"alerts:blocked")
              npm run alerts:blocked 2>&1 | tee output.txt
              ;;
            summary|"weekly summary"|"summary:weekly")
              npm run summary:weekly 2>&1 | tee output.txt
              ;;
            all|"run all"|"test:all")
              npm run test:all 2>&1 | tee output.txt
              ;;
            content*|"update content"*)
              # Parse content update from issue body
              # Expected format:
              # content update
              # page: about
              # section: headline
              # text: "New text"
              # revert: 1h (optional)

              ISSUE_BODY="${{ github.event.issue.body }}"

              PAGE=$(echo "$ISSUE_BODY" | grep -i "page:" | sed 's/page://I' | xargs)
              SECTION=$(echo "$ISSUE_BODY" | grep -i "section:" | sed 's/section://I' | xargs)
              TEXT=$(echo "$ISSUE_BODY" | grep -i "text:" | sed 's/text://I' | xargs | sed 's/^["'\'']//' | sed 's/["'\'']$//')
              REVERT=$(echo "$ISSUE_BODY" | grep -i "revert:" | sed 's/revert://I' | xargs)

              if [ -z "$PAGE" ] || [ -z "$SECTION" ] || [ -z "$TEXT" ]; then
                echo "âŒ Error: Missing required parameters" > output.txt
                echo "" >> output.txt
                echo "Content update requires:" >> output.txt
                echo "page: [home|about|works|hands|experiments|thoughts]" >> output.txt
                echo "section: [headline|description|background]" >> output.txt
                echo "text: \"Your new content\"" >> output.txt
                echo "revert: 1h (optional - auto-revert after 1 hour)" >> output.txt
              else
                # Run content update
                npm run content:update -- --page="$PAGE" --section="$SECTION" --text="$TEXT" 2>&1 | tee output.txt

                # If revert flag set, store commit hash for later revert
                if [ -n "$REVERT" ]; then
                  COMMIT_HASH=$(git rev-parse HEAD)
                  echo "" >> output.txt
                  echo "â° Auto-revert scheduled for: $REVERT" >> output.txt
                  echo "Commit to revert: $COMMIT_HASH" >> output.txt

                  # Store in issue comment for revert workflow
                  echo "REVERT_COMMIT=$COMMIT_HASH" >> $GITHUB_ENV
                  echo "REVERT_TIME=$REVERT" >> $GITHUB_ENV
                fi

                # Push changes
                git push 2>&1 | tee -a output.txt
                echo "" >> output.txt
                echo "âœ… Changes pushed to GitHub" >> output.txt
                echo "ðŸ”— View at: https://yellowcircle-app.web.app" >> output.txt
              fi
              ;;
            *)
              echo "Unknown command: $COMMAND" > output.txt
              echo "" >> output.txt
              echo "Available commands:" >> output.txt
              echo "- sync: Sync roadmap to Notion" >> output.txt
              echo "- wip: Run daily WIP sync" >> output.txt
              echo "- deadline: Check deadline alerts" >> output.txt
              echo "- blocked: Check blocked tasks" >> output.txt
              echo "- summary: Generate weekly summary" >> output.txt
              echo "- all: Run all automations" >> output.txt
              echo "- content update: Update page content" >> output.txt
              ;;
          esac

          # Read output for comment
          OUTPUT=$(cat output.txt)
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add auto-revert label
        if: github.event_name == 'issues' && env.REVERT_COMMIT != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['auto-revert']
            });

            // Add comment with revert info
            const revertComment = `## â° Auto-Revert Scheduled\n\nThis change will automatically revert in: **${{ env.REVERT_TIME }}**\n\nCommit to revert: \`${{ env.REVERT_COMMIT }}\`\n\nTo cancel auto-revert, remove the \`auto-revert\` label.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: revertComment
            });

      - name: Comment result on issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.execute.outputs.output }}`;
            const comment = `## âœ… Command Executed\n\n\`\`\`\n${output}\n\`\`\`\n\n*Executed by GitHub Actions at ${new Date().toISOString()}*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Close issue after execution
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              labels: ['command', 'executed']
            });

      - name: Create summary
        if: always()
        run: |
          echo "### Command Execution Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Command:** ${{ steps.parse.outputs.command }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Output:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat .claude/automation/output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
