name: Sign iOS Shortcut

on:
  repository_dispatch:
    types: [sign-shortcut]
  workflow_dispatch:
    inputs:
      slug:
        description: 'User slug/Save ID to sign shortcut for (or "universal" for universal shortcut)'
        required: true
        type: string
        default: 'universal'
      shortcut_type:
        description: 'Type of shortcut to generate'
        required: true
        type: choice
        options:
          - personalized
          - universal
        default: 'personalized'

jobs:
  sign-and-upload:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get inputs from dispatch or manual
        id: get-inputs
        run: |
          # Get slug
          if [ -n "${{ github.event.inputs.slug }}" ]; then
            echo "slug=${{ github.event.inputs.slug }}" >> $GITHUB_OUTPUT
          else
            echo "slug=${{ github.event.client_payload.slug }}" >> $GITHUB_OUTPUT
          fi

          # Get shortcut type (default to personalized if not specified)
          if [ -n "${{ github.event.inputs.shortcut_type }}" ]; then
            echo "type=${{ github.event.inputs.shortcut_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.client_payload.type }}" = "universal" ]; then
            echo "type=universal" >> $GITHUB_OUTPUT
          else
            echo "type=personalized" >> $GITHUB_OUTPUT
          fi

      - name: Validate slug
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"

          if [ -z "$SLUG" ]; then
            echo "Error: No slug provided"
            exit 1
          fi

          # Sanitize: lowercase, alphanumeric and hyphens only
          SANITIZED=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          if [ ${#SANITIZED} -lt 2 ] || [ ${#SANITIZED} -gt 30 ]; then
            echo "Error: Invalid slug length (must be 2-30 characters)"
            exit 1
          fi

          echo "Validated slug: $SANITIZED"
          echo "Shortcut type: $TYPE"

      - name: Generate shortcut plist
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
          UUID="FFFFFFFF-FFFF-4FFF-BFFF-$(date +%s | md5 | head -c 12 | tr '[:lower:]' '[:upper:]')"

          mkdir -p /tmp/shortcut-signing

          if [ "$TYPE" = "universal" ]; then
            # Use the universal shortcut template from the repo
            cp scripts/shortcut-generator/YellowCircle-Universal.shortcut.plist /tmp/shortcut-signing/universal-unsigned.shortcut
            echo "Using universal shortcut template (prompts for Save ID)"
          else
            # Generate personalized shortcut with hardcoded slug
            cat > /tmp/shortcut-signing/${SLUG}-unsigned.shortcut << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>WFWorkflowClientVersion</key>
  <string>2605.0.5</string>
  <key>WFWorkflowMinimumClientVersion</key>
  <integer>900</integer>
  <key>WFWorkflowMinimumClientVersionString</key>
  <string>900</string>
  <key>WFWorkflowName</key>
  <string>Save to yellowCircle</string>
  <key>WFWorkflowTypes</key>
  <array>
    <string>ActionExtension</string>
    <string>NCWidget</string>
    <string>WatchKit</string>
  </array>
  <key>WFWorkflowInputContentItemClasses</key>
  <array>
    <string>WFURLContentItem</string>
    <string>WFArticleContentItem</string>
    <string>WFSafariWebPageContentItem</string>
  </array>
  <key>WFWorkflowIcon</key>
  <dict>
    <key>WFWorkflowIconGlyphNumber</key>
    <integer>59819</integer>
    <key>WFWorkflowIconStartColor</key>
    <integer>4294956800</integer>
  </dict>
  <key>WFWorkflowActions</key>
  <array>
    <dict>
      <key>WFWorkflowActionIdentifier</key>
      <string>is.workflow.actions.gettext</string>
      <key>WFWorkflowActionParameters</key>
      <dict>
        <key>WFTextActionText</key>
        <dict>
          <key>Value</key>
          <dict>
            <key>string</key>
            <string>https://yellowcircle.io/s/${SLUG}/</string>
            <key>attachmentsByRange</key>
            <dict>
            </dict>
          </dict>
          <key>WFSerializationType</key>
          <string>WFTextTokenString</string>
        </dict>
        <key>UUID</key>
        <string>${UUID}</string>
      </dict>
    </dict>
    <dict>
      <key>WFWorkflowActionIdentifier</key>
      <string>is.workflow.actions.openurl</string>
      <key>WFWorkflowActionParameters</key>
      <dict>
        <key>WFInput</key>
        <dict>
          <key>Value</key>
          <dict>
            <key>string</key>
            <string>&#xFFFC;&#xFFFC;</string>
            <key>attachmentsByRange</key>
            <dict>
              <key>{0, 1}</key>
              <dict>
                <key>Type</key>
                <string>ActionOutput</string>
                <key>OutputName</key>
                <string>Text</string>
                <key>OutputUUID</key>
                <string>${UUID}</string>
              </dict>
              <key>{1, 1}</key>
              <dict>
                <key>Type</key>
                <string>ExtensionInput</string>
              </dict>
            </dict>
          </dict>
          <key>WFSerializationType</key>
          <string>WFTextTokenString</string>
        </dict>
      </dict>
    </dict>
    <dict>
      <key>WFWorkflowActionIdentifier</key>
      <string>is.workflow.actions.notification</string>
      <key>WFWorkflowActionParameters</key>
      <dict>
        <key>WFNotificationActionBody</key>
        <string>Link saved to yellowCircle!</string>
        <key>WFNotificationActionTitle</key>
        <string>Saved</string>
        <key>WFNotificationActionSound</key>
        <true/>
      </dict>
    </dict>
  </array>
</dict>
</plist>
EOF
            echo "Generated personalized plist for slug: $SLUG"
          fi

      - name: Convert to binary plist
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          if [ "$TYPE" = "universal" ]; then
            plutil -convert binary1 /tmp/shortcut-signing/universal-unsigned.shortcut
          else
            plutil -convert binary1 /tmp/shortcut-signing/${SLUG}-unsigned.shortcut
          fi
          echo "Converted to binary plist"

      - name: Sign shortcut
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          mkdir -p /tmp/signed-shortcuts

          if [ "$TYPE" = "universal" ]; then
            INPUT_FILE="/tmp/shortcut-signing/universal-unsigned.shortcut"
            OUTPUT_FILE="/tmp/signed-shortcuts/universal.shortcut"
          else
            INPUT_FILE="/tmp/shortcut-signing/${SLUG}-unsigned.shortcut"
            OUTPUT_FILE="/tmp/signed-shortcuts/${SLUG}.shortcut"
          fi

          shortcuts sign -i "$INPUT_FILE" -o "$OUTPUT_FILE" || true

          if [ -f "$OUTPUT_FILE" ]; then
            SIZE=$(stat -f%z "$OUTPUT_FILE")
            if [ $SIZE -gt 1000 ]; then
              echo "Signed successfully: ${SIZE} bytes"
            else
              echo "Error: Signed file too small"
              exit 1
            fi
          else
            echo "Error: Signed file not created"
            exit 1
          fi

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: yellowcircle-app

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Upload to Cloud Storage
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          if [ "$TYPE" = "universal" ]; then
            gsutil cp /tmp/signed-shortcuts/universal.shortcut gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/universal.shortcut
            echo "Uploaded to: gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/universal.shortcut"
          else
            gsutil cp /tmp/signed-shortcuts/${SLUG}.shortcut gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/${SLUG}.shortcut
            echo "Uploaded to: gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/${SLUG}.shortcut"
          fi

      - name: Verify upload
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          if [ "$TYPE" = "universal" ]; then
            gsutil ls -l gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/universal.shortcut
          else
            gsutil ls -l gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/${SLUG}.shortcut
          fi
          echo "Upload verified!"
