name: Sign iOS Shortcut

on:
  # Push trigger required: GitHub ghost-evaluates this workflow on every
  # push and shows a failure if no push handler exists. Adding push with
  # a matching branch + job-level skip makes it show "skipped" (neutral)
  # instead of "failed" (red X). The job if-guard prevents actual execution.
  push:
    branches:
      - main
  repository_dispatch:
    types: [sign-shortcut]
  workflow_dispatch:
    inputs:
      slug:
        description: 'User slug/Save ID to sign shortcut for (or "universal" for universal shortcut)'
        required: true
        type: string
        default: 'universal'
      shortcut_type:
        description: 'Type of shortcut to generate'
        required: true
        type: choice
        options:
          - personalized
          - universal
        default: 'personalized'

jobs:
  sign-and-upload:
    if: github.event_name != 'push'
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get inputs from dispatch or manual
        id: get-inputs
        run: |
          # Get slug
          if [ -n "${{ github.event.inputs.slug }}" ]; then
            echo "slug=${{ github.event.inputs.slug }}" >> $GITHUB_OUTPUT
          else
            echo "slug=${{ github.event.client_payload.slug }}" >> $GITHUB_OUTPUT
          fi

          # Get shortcut type (default to personalized if not specified)
          if [ -n "${{ github.event.inputs.shortcut_type }}" ]; then
            echo "type=${{ github.event.inputs.shortcut_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.client_payload.type }}" = "universal" ]; then
            echo "type=universal" >> $GITHUB_OUTPUT
          else
            echo "type=personalized" >> $GITHUB_OUTPUT
          fi

      - name: Validate slug
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"

          if [ -z "$SLUG" ]; then
            echo "Error: No slug provided"
            exit 1
          fi

          # Sanitize: lowercase, alphanumeric and hyphens only
          SANITIZED=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          if [ ${#SANITIZED} -lt 2 ] || [ ${#SANITIZED} -gt 30 ]; then
            echo "Error: Invalid slug length (must be 2-30 characters)"
            exit 1
          fi

          echo "Validated slug: $SANITIZED"
          echo "Shortcut type: $TYPE"

      - name: Generate shortcut plist
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          mkdir -p /tmp/shortcut-signing

          if [ "$TYPE" = "universal" ]; then
            cp scripts/shortcut-generator/YellowCircle-Universal.shortcut.plist /tmp/shortcut-signing/universal-unsigned.shortcut
            echo "Using universal shortcut template (prompts for Save ID)"
          else
            scripts/shortcut-generator/generate-personalized-plist.sh "$SLUG" "/tmp/shortcut-signing/${SLUG}-unsigned.shortcut"
          fi

      - name: Convert to binary plist
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          if [ "$TYPE" = "universal" ]; then
            plutil -convert binary1 /tmp/shortcut-signing/universal-unsigned.shortcut
          else
            plutil -convert binary1 /tmp/shortcut-signing/${SLUG}-unsigned.shortcut
          fi
          echo "Converted to binary plist"

      - name: Sign shortcut
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          mkdir -p /tmp/signed-shortcuts

          if [ "$TYPE" = "universal" ]; then
            INPUT_FILE="/tmp/shortcut-signing/universal-unsigned.shortcut"
            OUTPUT_FILE="/tmp/signed-shortcuts/universal.shortcut"
          else
            INPUT_FILE="/tmp/shortcut-signing/${SLUG}-unsigned.shortcut"
            OUTPUT_FILE="/tmp/signed-shortcuts/${SLUG}.shortcut"
          fi

          shortcuts sign -i "$INPUT_FILE" -o "$OUTPUT_FILE" || true

          if [ -f "$OUTPUT_FILE" ]; then
            SIZE=$(stat -f%z "$OUTPUT_FILE")
            if [ $SIZE -gt 1000 ]; then
              echo "Signed successfully: ${SIZE} bytes"
            else
              echo "Error: Signed file too small"
              exit 1
            fi
          else
            echo "Error: Signed file not created"
            exit 1
          fi

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: yellowcircle-app

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Upload to Cloud Storage
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          if [ "$TYPE" = "universal" ]; then
            gsutil cp /tmp/signed-shortcuts/universal.shortcut gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/universal.shortcut
            echo "Uploaded to: gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/universal.shortcut"
          else
            gsutil cp /tmp/signed-shortcuts/${SLUG}.shortcut gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/${SLUG}.shortcut
            echo "Uploaded to: gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/${SLUG}.shortcut"
          fi

      - name: Verify upload
        run: |
          SLUG="${{ steps.get-inputs.outputs.slug }}"
          TYPE="${{ steps.get-inputs.outputs.type }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          if [ "$TYPE" = "universal" ]; then
            gsutil ls -l gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/universal.shortcut
          else
            gsutil ls -l gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/${SLUG}.shortcut
          fi
          echo "Upload verified!"
