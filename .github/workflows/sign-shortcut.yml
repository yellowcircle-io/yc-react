name: Sign iOS Shortcut

on:
  repository_dispatch:
    types: [sign-shortcut]
  workflow_dispatch:
    inputs:
      slug:
        description: 'User slug/Save ID to sign shortcut for'
        required: true
        type: string

jobs:
  sign-and-upload:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get slug from input or dispatch
        id: get-slug
        run: |
          if [ -n "${{ github.event.inputs.slug }}" ]; then
            echo "slug=${{ github.event.inputs.slug }}" >> $GITHUB_OUTPUT
          else
            echo "slug=${{ github.event.client_payload.slug }}" >> $GITHUB_OUTPUT
          fi

      - name: Validate slug
        run: |
          SLUG="${{ steps.get-slug.outputs.slug }}"
          if [ -z "$SLUG" ]; then
            echo "Error: No slug provided"
            exit 1
          fi
          # Sanitize: lowercase, alphanumeric and hyphens only
          SANITIZED=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
          if [ ${#SANITIZED} -lt 2 ] || [ ${#SANITIZED} -gt 30 ]; then
            echo "Error: Invalid slug length (must be 2-30 characters)"
            exit 1
          fi
          echo "Validated slug: $SANITIZED"

      - name: Generate shortcut plist
        run: |
          SLUG="${{ steps.get-slug.outputs.slug }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
          UUID="FFFFFFFF-FFFF-4FFF-BFFF-$(date +%s | md5 | head -c 12 | tr '[:lower:]' '[:upper:]')"

          mkdir -p /tmp/shortcut-signing

          cat > /tmp/shortcut-signing/${SLUG}-unsigned.shortcut << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>WFWorkflowClientVersion</key>
            <string>2605.0.5</string>
            <key>WFWorkflowMinimumClientVersion</key>
            <integer>900</integer>
            <key>WFWorkflowMinimumClientVersionString</key>
            <string>900</string>
            <key>WFWorkflowName</key>
            <string>Save to yellowCircle</string>
            <key>WFWorkflowTypes</key>
            <array>
              <string>ActionExtension</string>
            </array>
            <key>WFWorkflowInputContentItemClasses</key>
            <array>
              <string>WFURLContentItem</string>
              <string>WFArticleContentItem</string>
            </array>
            <key>WFWorkflowIcon</key>
            <dict>
              <key>WFWorkflowIconGlyphNumber</key>
              <integer>59819</integer>
              <key>WFWorkflowIconStartColor</key>
              <integer>4294956800</integer>
            </dict>
            <key>WFWorkflowActions</key>
            <array>
              <dict>
                <key>WFWorkflowActionIdentifier</key>
                <string>is.workflow.actions.gettext</string>
                <key>WFWorkflowActionParameters</key>
                <dict>
                  <key>WFTextActionText</key>
                  <dict>
                    <key>Value</key>
                    <dict>
                      <key>string</key>
                      <string>https://yellowcircle.io/s/${SLUG}/</string>
                      <key>attachmentsByRange</key>
                      <dict>
                      </dict>
                    </dict>
                    <key>WFSerializationType</key>
                    <string>WFTextTokenString</string>
                  </dict>
                  <key>UUID</key>
                  <string>${UUID}</string>
                </dict>
              </dict>
              <dict>
                <key>WFWorkflowActionIdentifier</key>
                <string>is.workflow.actions.openurl</string>
                <key>WFWorkflowActionParameters</key>
                <dict>
                  <key>WFInput</key>
                  <dict>
                    <key>Value</key>
                    <dict>
                      <key>string</key>
                      <string>&#xFFFC;&#xFFFC;</string>
                      <key>attachmentsByRange</key>
                      <dict>
                        <key>{0, 1}</key>
                        <dict>
                          <key>Type</key>
                          <string>ActionOutput</string>
                          <key>OutputName</key>
                          <string>Text</string>
                          <key>OutputUUID</key>
                          <string>${UUID}</string>
                        </dict>
                        <key>{1, 1}</key>
                        <dict>
                          <key>Type</key>
                          <string>ExtensionInput</string>
                        </dict>
                      </dict>
                    </dict>
                    <key>WFSerializationType</key>
                    <string>WFTextTokenString</string>
                  </dict>
                </dict>
              </dict>
            </array>
          </dict>
          </plist>
          EOF

          echo "Generated plist for slug: $SLUG"

      - name: Convert to binary plist
        run: |
          SLUG="${{ steps.get-slug.outputs.slug }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
          plutil -convert binary1 /tmp/shortcut-signing/${SLUG}-unsigned.shortcut
          echo "Converted to binary plist"

      - name: Sign shortcut
        run: |
          SLUG="${{ steps.get-slug.outputs.slug }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
          mkdir -p /tmp/signed-shortcuts
          shortcuts sign -i /tmp/shortcut-signing/${SLUG}-unsigned.shortcut -o /tmp/signed-shortcuts/${SLUG}.shortcut || true

          if [ -f /tmp/signed-shortcuts/${SLUG}.shortcut ]; then
            SIZE=$(stat -f%z /tmp/signed-shortcuts/${SLUG}.shortcut)
            if [ $SIZE -gt 1000 ]; then
              echo "Signed successfully: ${SIZE} bytes"
            else
              echo "Error: Signed file too small"
              exit 1
            fi
          else
            echo "Error: Signed file not created"
            exit 1
          fi

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: yellowcircle-app

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

      - name: Upload to Cloud Storage
        run: |
          SLUG="${{ steps.get-slug.outputs.slug }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          gsutil cp /tmp/signed-shortcuts/${SLUG}.shortcut gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/${SLUG}.shortcut

          echo "Uploaded to: gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/${SLUG}.shortcut"

      - name: Verify upload
        run: |
          SLUG="${{ steps.get-slug.outputs.slug }}"
          SLUG=$(echo "$SLUG" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')

          gsutil ls -l gs://yellowcircle-app.firebasestorage.app/shortcuts/signed/${SLUG}.shortcut
          echo "Upload verified!"
